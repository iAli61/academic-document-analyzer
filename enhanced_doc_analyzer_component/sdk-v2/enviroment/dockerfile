FROM mcr.microsoft.com/azureml/curated/acpt-pytorch-2.2-cuda12.1:18

# Create model directory
RUN mkdir -p /root/.cache/huggingface/hub/models--facebook--nougat-base/

# Download model files
RUN cd /root/.cache/huggingface/hub/models--facebook--nougat-base/ && \
    wget -q https://github.com/facebookresearch/nougat/releases/download/0.1.0-base/config.json && \
    wget -q https://github.com/facebookresearch/nougat/releases/download/0.1.0-base/pytorch_model.bin && \
    wget -q https://github.com/facebookresearch/nougat/releases/download/0.1.0-base/tokenizer.json && \
    wget -q https://github.com/facebookresearch/nougat/releases/download/0.1.0-base/tokenizer_config.json && \
    wget -q https://github.com/facebookresearch/nougat/releases/download/0.1.0-base/special_tokens_map.json

# Set environment variable for Nougat
ENV NOUGAT_CHECKPOINT=/root/.cache/huggingface/hub/models--facebook--nougat-base

# Fix Nougat transforms configuration
RUN sed -i 's/alb.ImageCompression(95, p=0.07),/alb.ImageCompression(quality_lower=95, quality_upper=100, compression_type="jpeg", p=0.07),/' \
    /opt/conda/envs/doc_analyzer_env/lib/python3.9/site-packages/nougat/transforms.py

# Verify the model files
RUN echo "Verifying downloaded files..." && \
    ls -l /root/.cache/huggingface/hub/models--facebook--nougat-base/ && \
    echo "Model setup complete."